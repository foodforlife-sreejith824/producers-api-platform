
steps:
  - checkout: none
  - task: HelmInstaller@1
    displayName: "install helm"

  - bash: |

       az login --service-principal --username $(AKS_SP_ID) --password $(AKS_SP_PASSWORD) --tenant $(AKS_SP_TENANT)
       az aks get-credentials -n $(CLUSTER_NAME) -g $(CLUSTER_RESOURCE_GROUP)

       echo $(ACR_HELM_SP_PASSWORD) | helm registry login $(ACR_SERVER_NAME) --username $(ACR_HELM_SP_USERNAME) --password-stdin

       helm chart pull $(ACR_SERVER_NAME)/$(HELM_CHART):latest
       helm chart export $(ACR_SERVER_NAME)/$(HELM_CHART):latest --destination $(pipeline.workspace)/install
       
       helm upgrade --namespace $(k8sNamespace) --create-namespace --install $(projectName) $(pipeline.workspace)/install/$(HELM_CHART)
    failOnStderr: true
    displayName: "deploy helm chart"