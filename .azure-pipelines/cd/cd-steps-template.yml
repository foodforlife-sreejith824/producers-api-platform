
steps:
  - checkout: none
  - task: HelmInstaller@1
    displayName: "install helm"

  - bash: |

       az login --service-principal --username $(AKS_SP_ID) --password $(AKS_SP_PASSWORD) --tenant $(AKS_SP_TENANT)
       az aks get-credentials -n ${{ variables.aksClusterName }} -g ${{ variables.resourceGroup }} 

       echo $(ACR_HELM_SP_PASSWORD) | helm registry login ${{ variables.registryServerName }} --username $(ACR_HELM_SP_USERNAME) --password-stdin

       helm chart pull ${{ variables.registryServerName }}/${{ variables.helmChart }}:latest
       helm chart export ${{ variables.registryServerName }}/${{ variables.helmChart }}:latest --destination $(pipeline.workspace)/install
       
       helm upgrade --namespace ${{ variables.aksNamespace }} --create-namespace --install ${{ variables.projectName }} $(pipeline.workspace)/install/${{ variables.helmChart }}
    failOnStderr: true
    displayName: "deploy helm chart"